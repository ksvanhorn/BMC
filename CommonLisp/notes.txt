NOTATION
--------

dot: inner product of two tensors
^2: synonym for sqr
^1/2: synonym for sqrt
^-1/2
^-1: synonym for unary /
^-2: (^-2 x) == (^ x -2)
@^2: ^2 applied elementwise to an array
@^1/2: ^1/2 applied elementwise
@^-1/2
@^-1: ^-1 applied elementwise to an array
@^-2: ^-2 applied elementwise to an array
@+
@-
@*
@/
diag_mat
o* outer product
o^2 self outer product
$* multiply array by scalar
q@sum: quantified elementwise sum of arrays
rmat: matrix formed by stacking rows
qrmat: quantified form of rmat


TODO
----

Handle quantifiers having non-trivial filters when printing out expressions.

+Add update parameters to class.
Generation of update
Computation of log proposal density


- Draw from joint distribution.
- Make copy of sampler object.
- Do update on copy.
- Compute ljd_new - ljd_old + log_proposal_density_new - log_proposal_density_old
- Compute given acceptance ratio
- Compare.

- CHECK THAT log acceptance factor DOES NOT DEPEND ON ANY VARS DECLARED IN
  A LET ENCLOSING THE M-H RELATION (other than index variables?)
- For updates, need to check that ranges of enclosing for loops and tests
  of enclosing if-then-else's have no dependence on vars being updated.
- Need to fix TestUpdate_FOO(MyModel x, double tol) to include parameters
  for vars of any enclosing let's and loops used in the update.

(write-rel-draw <rel> &optional <let-needs-brackets>)
(write-ljd-accum-rel <accum-var-name> <rel> <let-needs-brackets> <var-name-pfx>)

// Overall
(write-test-updates <class-name> <update-names>
  &optional <write-test-update-fct> )
(write-test-is-dag-update <class-name> <update-name> <rel> <model-vars>
  <assigned-vars> <dim-fct> &optional <write-body>)
- (write-rel-draw-with-dag-test <rel> <model-vars> <dim-fct>)
  - (write-assigned-test <rel> <dim-fct>)
- (args-vars-names <mdl>)
- (model-variables-assigned-in <rel>)
- (model->dim-fct <mdl>)

// For a Gibbs update:
(write-test-gibbs-update <class-name> <update-name>)
(write-log-draw-density-of-update <class-name> <update-name> <rel> <model-vars>
 &optional write-body)
(write-body-ldd-of-update <rel> <model-vars>)
// Also needs DAG test?

// For a M-H update:
(write-test-mh-update <class-name> <update-name>)

[write-test-file: (UNTESTED... but it's just "glue") 
- calls make-write-test-update-fct 
- calls write-test-updates]
[make-write-test-update-fct (UNTESTED... but it's mostly "glue")
- calls write-test-update]
[write-test-update (UNTESTED ... mostly "glue", sequencing)
- calls write-test-update-main
- calls write-test-is-dag-update
- calls write-test-outer-invariance
- calls write-test-acceptance-ratio (TODO)]
[write-test-update-main]
[write-test-is-dag-update
- calls write-rel-draw-with-dag-test]
[write-test-outer-invariance
- calls write-test-outer-invariance-body]
[write-test-acceptance-ratio...


TestIsDAG_Update_ALPHA(x); (apply to Gibbs updates and proposal distr of M-H)
-- write-test-is-dag-update
TestOuterLetsAreInvariant_ALPHA(x); (apply to M-H updates)
-- write-test-outer-lets
TestAcceptanceRatio_ALPHA(x, tol);
-- write-test-acceptance-ratio

*** REMOVE unnecessary arguments in adt-case clauses ***

For each variable update var[idx1,...,idxn] <- val, record
((var, idx1, ..., idxn), old-val, new-val)
var _save_X = BMC.Recorder(X);
_save_X.Record(X[...]);
_save_X.Replay();
_save_X.Next();
_save_X.AtEnd();


(:quant qand i (m n) (p i)) == (reduce-qand true (qvec i (m n) (p i)))

(:quant qor i (m n) (p i)) == (reduce-qor false (qvec i (m n) (p i)))

(:quant qmin i (m n) (f i)) == (reduce-qmin %infty+ (qvec i (m n) (p i)))

(:quant qmax i (m n) (f i)) == (reduce-qmax %infty- (qvec i (m n) (p i)))

(:quant qnum i (m n) (p i)) == (reduce-f 0 (qvec i (m n) (p i)))
where f(n, y) = n + bool-to-int(y)

(:quant qsum i (m n) (f i)) == (reduce-+ 0 (qvec i (m n) (f i)))
  
(:quant qprod i (m n) (f i)) == (reduce-* 0 (qvec i (m n) (f i)))

(:quant q@sum i (m n) (f i)) == (reduce-@+ (qvec i (m n) (f i))) if m <= n
                             == %undef                           otherwise ???

(:quant qmat i (m n) (f i)) == (reduce-cons-row ? (qvec i (m n) (f i)))

// These go in the test class

